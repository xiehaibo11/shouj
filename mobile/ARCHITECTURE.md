# Clash Verge Mobile æ¶æ„è®¾è®¡

## ğŸ“ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Mobile Frontend                     â”‚
â”‚              (React Native + TypeScript)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚    Screens   â”‚  â”‚  Components  â”‚  â”‚   Hooks    â”‚â”‚
â”‚  â”‚  (HomeScreen)â”‚  â”‚  (ProxyList) â”‚  â”‚(useProxies)â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   Services   â”‚  â”‚    Utils     â”‚  â”‚   Themes   â”‚â”‚
â”‚  â”‚    (API)     â”‚  â”‚  (Formatters)â”‚  â”‚  (Styles)  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†• Tauri IPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Backend (Rust)                      â”‚
â”‚                  [å¤ç”¨æ¡Œé¢ç‰ˆ]                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Core Manager â”‚  â”‚Config Managerâ”‚  â”‚Profile Mgr â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          Mihomo Core (Go Binary)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Platform Layer                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Android Native     â”‚      iOS Native              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ VPN Service    â”‚  â”‚  â”‚ Network Extension      â”‚ â”‚
â”‚  â”‚ (ClashVpnSvc)  â”‚  â”‚  â”‚ (PacketTunnelProvider) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§© æ ¸å¿ƒæ¨¡å—

### 1. å‰ç«¯å±‚ (React Native)

#### å¯¼èˆªç³»ç»Ÿ
- **React Navigation**: é¡µé¢è·¯ç”±å’Œå¯¼èˆªæ ˆç®¡ç†
- **å±å¹•**: Home, Proxies, Profiles, Connections, Rules, Logs, Settings
- **æ·±å±‚é“¾æ¥**: æ”¯æŒ `clash://` å’Œ `clash-verge://` URL Scheme

#### çŠ¶æ€ç®¡ç†
- **SWR**: æ•°æ®è·å–å’Œç¼“å­˜
- **Zustand**: å…¨å±€çŠ¶æ€ç®¡ç†ï¼ˆVPNçŠ¶æ€ã€è®¾ç½®ç­‰ï¼‰
- **React Context**: åº”ç”¨çº§æ•°æ®å…±äº«

#### UIç»„ä»¶åº“
- **React Native Paper**: Material Design 3 ç»„ä»¶
- **React Native Vector Icons**: å›¾æ ‡åº“
- **è‡ªå®šä¹‰ç»„ä»¶**: ProxyCard, ConnectionItem, LogItemç­‰

### 2. æœåŠ¡å±‚ (Services)

#### APIæœåŠ¡ (`api.ts`)
```typescript
// Clash APIè°ƒç”¨
getAxios() â†’ Axioså®ä¾‹
getProxies() â†’ ä»£ç†åˆ—è¡¨
selectProxy() â†’ åˆ‡æ¢ä»£ç†
getConnections() â†’ è¿æ¥åˆ—è¡¨
getRules() â†’ è§„åˆ™åˆ—è¡¨
getIpInfo() â†’ IPä¿¡æ¯
```

#### åˆå§‹åŒ–æœåŠ¡ (`initialize.ts`)
```typescript
initializeApp() â†’ åº”ç”¨å¯åŠ¨åˆå§‹åŒ–
loadSettings() â†’ åŠ è½½æœ¬åœ°è®¾ç½®
setupEventListeners() â†’ äº‹ä»¶ç›‘å¬
```

#### VPNæœåŠ¡ (`vpn.ts`)
```typescript
requestVpnPermission() â†’ è¯·æ±‚VPNæƒé™
startVpn() â†’ å¯åŠ¨VPN
stopVpn() â†’ åœæ­¢VPN
getVpnStatus() â†’ VPNçŠ¶æ€
```

### 3. Hookså±‚

| Hook | åŠŸèƒ½ | ä¸»è¦æ–¹æ³• |
|------|------|----------|
| `useProxies` | ä»£ç†ç®¡ç† | `select()`, `mutate()` |
| `useProfiles` | é…ç½®ç®¡ç† | `selectProfile()`, `createProfile()` |
| `useConnections` | è¿æ¥ç›‘æ§ | `connections`, `mutate()` |
| `useRules` | è§„åˆ™ç®¡ç† | `rules`, `mutate()` |
| `useLogs` | æ—¥å¿—æ˜¾ç¤º | `logs`, `clearLogs()` |
| `useSettings` | è®¾ç½®ç®¡ç† | `updateSetting()`, `resetSettings()` |

### 4. åç«¯å±‚ (Rust)

#### æ ¸å¿ƒæ¨¡å— (å¤ç”¨æ¡Œé¢ç‰ˆ)
```
src-tauri/src/
â”œâ”€â”€ core/          # æ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ manager/   # Mihomoè¿›ç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ handle.rs  # åº”ç”¨å¥æŸ„
â”‚   â”œâ”€â”€ hotkey.rs  # å¿«æ·é”®ï¼ˆç§»åŠ¨ç«¯ç¦ç”¨ï¼‰
â”‚   â””â”€â”€ service.rs # æœåŠ¡ç®¡ç†
â”œâ”€â”€ config/        # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ clash.rs   # Clashé…ç½®
â”‚   â”œâ”€â”€ profiles.rs# é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ verge.rs   # Vergeé…ç½®
â”œâ”€â”€ cmd/           # Tauriå‘½ä»¤
â”‚   â”œâ”€â”€ app.rs     # åº”ç”¨å‘½ä»¤
â”‚   â”œâ”€â”€ clash.rs   # Clashå‘½ä»¤
â”‚   â””â”€â”€ profile.rs # é…ç½®å‘½ä»¤
â””â”€â”€ enhance/       # å¢å¼ºåŠŸèƒ½
    â”œâ”€â”€ merge.rs   # é…ç½®åˆå¹¶
    â””â”€â”€ script.rs  # è„šæœ¬æ‰§è¡Œ
```

#### Tauriå‘½ä»¤
```rust
// ç§»åŠ¨ç«¯éœ€è¦çš„æ ¸å¿ƒå‘½ä»¤
#[tauri::command]
pub async fn get_clash_info() -> Result<ClashInfo>
#[tauri::command]
pub async fn patch_clash_config(payload: Mapping) -> Result<()>
#[tauri::command]
pub async fn get_proxies() -> Result<ProxiesMapping>
#[tauri::command]
pub async fn select_proxy(group: String, name: String) -> Result<()>
#[tauri::command]
pub async fn get_profiles() -> Result<ProfilesConfig>
#[tauri::command]
pub async fn import_profile(url: String) -> Result<()>
```

### 5. å¹³å°å±‚ (Native)

#### Android VPNæœåŠ¡
```kotlin
// ClashVpnService.kt
class ClashVpnService : VpnService() {
    fun startVPN() {
        // 1. å»ºç«‹VPNæ¥å£
        val builder = Builder()
            .setSession("Clash Verge")
            .addAddress("172.19.0.1", 30)
            .addRoute("0.0.0.0", 0)
        
        // 2. å¯åŠ¨Mihomoè¿›ç¨‹
        startProxyCore()
        
        // 3. è½¬å‘ç½‘ç»œæµé‡
        setupTrafficRouting()
    }
}
```

#### iOS Network Extension
```swift
// PacketTunnelProvider.swift
class PacketTunnelProvider: NEPacketTunnelProvider {
    override func startTunnel() {
        // 1. é…ç½®ç½‘ç»œè®¾ç½®
        let settings = NEPacketTunnelNetworkSettings()
        
        // 2. å¯åŠ¨Mihomoè¿›ç¨‹
        startProxyCore()
        
        // 3. å¤„ç†æ•°æ®åŒ…
        handlePackets()
    }
}
```

## ğŸ”„ æ•°æ®æµ

### ä»£ç†åˆ‡æ¢æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»ä»£ç†
    â†“
ProxyScreen.onSelect()
    â†“
useProxies.select(proxyName)
    â†“
api.selectProxy(group, proxyName)
    â†“
Tauri IPC: select_proxy
    â†“
Rust Backend: handle_select_proxy()
    â†“
Mihomo API: /proxies/{group}
    â†“
Clash Coreæ›´æ–°ä»£ç†
    â†“
SWR mutate() åˆ·æ–°UI
```

### VPNå¯åŠ¨æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»è¿æ¥
    â†“
HomeScreen.onConnect()
    â†“
vpn.requestVpnPermission()
    â†“ (æˆæƒæˆåŠŸ)
vpn.startVpn()
    â†“
Platform Native: startVpnService()
    â†“
å»ºç«‹VPNéš§é“
    â†“
Tauri IPC: start_clash_core
    â†“
Rust Backend: CoreManager.run()
    â†“
å¯åŠ¨Mihomoè¿›ç¨‹
    â†“
å¼€å§‹è½¬å‘æµé‡
```

## ğŸ” å®‰å…¨è®¾è®¡

### 1. æ•°æ®å­˜å‚¨
- **æ•æ„Ÿé…ç½®**: ä½¿ç”¨å¹³å°åŠ å¯†å­˜å‚¨ï¼ˆKeychain/KeyStoreï¼‰
- **ç¼“å­˜æ•°æ®**: ä½¿ç”¨åº”ç”¨æ²™ç›’
- **æ—¥å¿—æ–‡ä»¶**: å®šæœŸæ¸…ç†ï¼Œé™åˆ¶å¤§å°

### 2. æƒé™ç®¡ç†
```typescript
// è¿è¡Œæ—¶æƒé™æ£€æŸ¥
const permissions = {
    android: ['BIND_VPN_SERVICE', 'FOREGROUND_SERVICE'],
    ios: ['NetworkExtension']
};
```

### 3. ç½‘ç»œå®‰å…¨
- TLSè¯ä¹¦éªŒè¯
- é˜²æ­¢DNSæ³„éœ²
- WebRTCæ³„éœ²é˜²æŠ¤

## ğŸ“± ç§»åŠ¨ç«¯ç‰¹æœ‰è®¾è®¡

### 1. ç”µæ± ä¼˜åŒ–
- **åå°ä»»åŠ¡**: ä½¿ç”¨Workmanagerï¼ˆAndroidï¼‰/ Background Tasksï¼ˆiOSï¼‰
- **ç½‘ç»œè½®è¯¢**: æ ¹æ®ç”µæ± çŠ¶æ€è°ƒæ•´é¢‘ç‡
- **å”¤é†’é”**: ä»…åœ¨å¿…è¦æ—¶æŒæœ‰

### 2. æµé‡ç»Ÿè®¡
```typescript
interface TrafficStats {
    upload: number;
    download: number;
    connections: number;
}
```

### 3. å¿«æ·æ“ä½œ
- **Android**: Quick Settings Tile
- **iOS**: Widget / Shortcuts

### 4. é€šçŸ¥
```typescript
// è¿æ¥çŠ¶æ€é€šçŸ¥
showNotification({
    title: 'Clash Verge',
    body: 'VPNå·²è¿æ¥',
    ongoing: true,
    actions: ['æ–­å¼€', 'åˆ‡æ¢èŠ‚ç‚¹']
});
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- å·¥å…·å‡½æ•°æµ‹è¯•
- Hooké€»è¾‘æµ‹è¯•
- çŠ¶æ€ç®¡ç†æµ‹è¯•

### é›†æˆæµ‹è¯•
- APIè°ƒç”¨æµ‹è¯•
- VPNå¯åŠ¨æµç¨‹æµ‹è¯•
- é…ç½®å¯¼å…¥å¯¼å‡ºæµ‹è¯•

### E2Eæµ‹è¯•
- å®Œæ•´ç”¨æˆ·æµç¨‹æµ‹è¯•
- è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•

## ğŸ¨ UI/UXè®¾è®¡åŸåˆ™

1. **Material Design 3**: éµå¾ªæœ€æ–°è®¾è®¡è§„èŒƒ
2. **å“åº”å¼å¸ƒå±€**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸
3. **æ‰‹åŠ¿æ“ä½œ**: ä¸‹æ‹‰åˆ·æ–°ã€ä¾§æ»‘åˆ é™¤
4. **åŠ è½½çŠ¶æ€**: SkeletonåŠ è½½ã€ä¸‹æ‹‰åˆ·æ–°
5. **é”™è¯¯å¤„ç†**: å‹å¥½çš„é”™è¯¯æç¤º

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ¸²æŸ“ä¼˜åŒ–
- ä½¿ç”¨ `React.memo` é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- FlatListè™šæ‹ŸåŒ–åˆ—è¡¨
- å›¾ç‰‡æ‡’åŠ è½½

### 2. å†…å­˜ç®¡ç†
- åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
- æ§åˆ¶æ—¥å¿—ç¼“å­˜å¤§å°
- WebSocketè¿æ¥å¤ç”¨

### 3. å¯åŠ¨ä¼˜åŒ–
- å»¶è¿ŸåŠ è½½éå…³é”®æ¨¡å—
- é¢„åŠ è½½å…³é”®æ•°æ®
- ä½¿ç”¨Hermeså¼•æ“

## ğŸ”Œ æ‰©å±•æ€§

### æ’ä»¶ç³»ç»Ÿï¼ˆæœªæ¥è§„åˆ’ï¼‰
- è‡ªå®šä¹‰è§„åˆ™å¼•æ“
- ç¬¬ä¸‰æ–¹ä¸»é¢˜
- è„šæœ¬æ‰©å±•

### å¤šæ ¸å¿ƒæ”¯æŒ
- Clash Meta (Mihomo)
- Clash Premium
- Sing-box

## ğŸ“ æŠ€æœ¯å€ºåŠ¡

1. âš ï¸ VPNè¿›ç¨‹é€šä¿¡éœ€è¦ä¼˜åŒ–
2. âš ï¸ iOS Network Extensionæ€§èƒ½è°ƒä¼˜
3. âš ï¸ æ—¥å¿—ç³»ç»Ÿéœ€è¦é‡æ„
4. âš ï¸ é…ç½®è¿ç§»å·¥å…·å¾…å®Œå–„

## ğŸš€ æœªæ¥è§„åˆ’

- [ ] æ”¯æŒWireguardåè®®
- [ ] è®¢é˜…è½¬æ¢æœåŠ¡
- [ ] æ™ºèƒ½åˆ†æµè§„åˆ™
- [ ] å¤šè®¾å¤‡åŒæ­¥
- [ ] WebDAVå¤‡ä»½

