name: Android Build

on:
  workflow_dispatch:
  push:
    tags:
      - "android-v*.*.*"
    branches:
      - main
    paths:
      - 'mobile/**'
      - '.github/workflows/android-build.yml'
  pull_request:
    paths:
      - 'mobile/**'

permissions: write-all

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short
  HUSKY: 0

concurrency:
  group: "${{ github.workflow }} - ${{ github.head_ref || github.ref }}"
  cancel-in-progress: true

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - aarch64  # ARM64 (64ä½ï¼Œä¸»æµè®¾å¤‡)
          - armv7    # ARMv7 (32ä½ï¼Œè€è®¾å¤‡)
          - x86_64   # x86 64ä½ (æ¨¡æ‹Ÿå™¨)
          - universal # é€šç”¨åŒ…ï¼ˆåŒ…å«æ‰€æœ‰æž¶æž„ï¼‰

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust Android Targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          rustup target add i686-linux-android

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-all-crates: true
          shared-key: android-${{ matrix.target }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: Build for Android
        working-directory: mobile
        run: |
          if [ "${{ matrix.target }}" == "universal" ]; then
            pnpm run android:build:universal
          else
            pnpm run android:build:${{ matrix.target }}
          fi
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"

      - name: Find APK Files
        id: find-apk
        run: |
          echo "Finding APK files..."
          find mobile/app/build/outputs/apk -name "*.apk" -type f
          
          # èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
          VERSION=$(cat package.json | jq -r .version)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: clash-verge-rev-${{ matrix.target }}-${{ steps.find-apk.outputs.VERSION }}
          path: |
            mobile/app/build/outputs/apk/**/*.apk
          retention-days: 30

  release:
    name: Create Release
    needs: build-android
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/android-v')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        run: |
          VERSION=$(cat package.json | jq -r .version)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          TAG_NAME=${GITHUB_REF##*/}
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: apk-artifacts

      - name: Prepare Release Files
        run: |
          mkdir -p release-files
          find apk-artifacts -name "*.apk" -type f -exec cp {} release-files/ \;
          
          echo "APK files prepared for release:"
          ls -lh release-files/

      - name: Generate Release Notes
        run: |
          cat > release-notes.md << EOF
          # Clash Verge Rev Android - ${{ env.TAG_NAME }}
          
          ## ðŸ“± Android ç‰ˆæœ¬å‘å¸ƒ
          
          ### ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬å·: ${{ env.VERSION }}
          - æž„å»ºæ—¶é—´: $(TZ=Asia/Shanghai date)
          - Git æäº¤: ${{ github.sha }}
          
          ### ä¸‹è½½è¯´æ˜Ž
          
          #### ARM64 (æŽ¨è - é€‚ç”¨äºŽå¤§å¤šæ•°çŽ°ä»£è®¾å¤‡)
          - é€‚ç”¨äºŽ 2015 å¹´åŽçš„å¤§å¤šæ•° Android è®¾å¤‡
          - 64 ä½æž¶æž„ï¼Œæ€§èƒ½æœ€ä½³
          
          #### ARMv7 (é€‚ç”¨äºŽè€è®¾å¤‡)
          - é€‚ç”¨äºŽ 2015 å¹´å‰çš„éƒ¨åˆ†è®¾å¤‡
          - 32 ä½æž¶æž„
          
          #### x86_64 (é€‚ç”¨äºŽæ¨¡æ‹Ÿå™¨)
          - é€‚ç”¨äºŽ Android æ¨¡æ‹Ÿå™¨
          - 64 ä½ x86 æž¶æž„
          
          #### Universal (é€šç”¨ç‰ˆæœ¬)
          - åŒ…å«æ‰€æœ‰æž¶æž„ï¼Œä½“ç§¯è¾ƒå¤§
          - é€‚ç”¨äºŽæ‰€æœ‰è®¾å¤‡ï¼Œä½†ä½“ç§¯æœ€å¤§
          
          ### å®‰è£…è¦æ±‚
          - Android 7.0 (API 24) åŠä»¥ä¸Š
          - è‡³å°‘ 100MB å¯ç”¨å­˜å‚¨ç©ºé—´
          
          ### æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡å®‰è£…éœ€è¦å…è®¸"å®‰è£…æœªçŸ¥åº”ç”¨"æƒé™
          - å¦‚é‡å®‰è£…é—®é¢˜ï¼Œè¯·å…ˆå¸è½½æ—§ç‰ˆæœ¬
          
          ### å¸¸è§é—®é¢˜
          - [FAQ æ–‡æ¡£](https://github.com/${{ github.repository }}/wiki)
          
          ---
          
          æž„å»ºäºŽ GitHub Actions
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Android Release ${{ env.TAG_NAME }}"
          body_path: release-notes.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            release-files/*.apk

  # éž tag æŽ¨é€æ—¶çš„æž„å»ºé€šçŸ¥
  build-notification:
    name: Build Notification
    needs: build-android
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Summary
        run: |
          echo "## âœ… Android æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æž„å»ºå·²å®Œæˆï¼ŒAPK æ–‡ä»¶å·²ä½œä¸º Artifacts ä¸Šä¼ ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æŸ¥çœ‹æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "å‰å¾€ Actions é¡µé¢ä¸‹è½½æž„å»ºçš„ APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å¦‚ä½•åˆ›å»ºæ­£å¼å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
          echo "åˆ›å»ºä»¥ \`android-v\` å¼€å¤´çš„ tag æ¥è§¦å‘æ­£å¼å‘å¸ƒï¼Œä¾‹å¦‚ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git tag android-v1.0.0" >> $GITHUB_STEP_SUMMARY
          echo "git push origin android-v1.0.0" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

